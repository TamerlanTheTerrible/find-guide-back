<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide Finder WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 0;
            color: white;
            background: #202020;
        }

        form {
            width: 90%;
            max-width: 500px; /* Set a maximum width for mobile-friendly layout */
        }

        .switch-container {
            display: inline-flex;
            justify-content: left;
            align-items: center;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
        }

        .form-row > div {
            flex: 1;
            margin-right: 10px;
        }

        input,
        textarea,
        select {
            width: 100%;
            font-size: 16px;
            color: #202020;
            background: white;
            border-radius: 6px;
            margin-bottom: 3px;
        }

        input[type="date"] {
            padding: 7px 4px;
        }

        textarea {
            height: 50px;
        }

        select {
            padding: 7px;
        }

        form div {
            margin-bottom: 5px;
        }

        label {
            font-style: italic;
        }

        /*switch*/
        /* The switch - the box around the slider */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-right: 17px;
            margin-bottom: 3px;
        }

        /* Hide default HTML checkbox */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* The slider */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 15px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
    </style>
</head>

<body>
<form>
    <!--    switches-->
    <div class="form-row">
        <!--    date-->
        <div class="switch-container">
            <label class="switch">
                <input type="checkbox" id="isOneDay" onclick="enable(document.getElementById('toDate'), this.checked)">
                <span class="slider round"></span>
            </label>
            <label for="isOneDay">for one day</label>
        </div>
        <!--    has car-->
        <div class="switch-container">
            <label class="switch">
                <input type="checkbox" id="hasCar">
                <span class="slider round"></span>
            </label>
            <label for="hasCar">has car</label>
        </div>
    </div>

    <!--    dates-->
    <div class="form-row">
        <div>
            <label for="fromDate">From date:</label>
            <input type="date" id="fromDate" name="fromDate" required="required">
            <span class="warning" id="nameWarning" style="display: none;">Please enter your name.</span>
        </div>
        <div>
            <label for="toDate">To date:</label>
            <input type="date" id="toDate" name="toDate">
        </div>
    </div>

    <!--    region-->
    <div>
        <label for="region">Region:</label>
        <select id="region" name="region">
        </select>
    </div>

    <!--    language-->
    <div>
        <label for="language">Language:</label>
        <select id="language" name="language">
        </select>
    </div>

    <!--    comments-->
    <div >
        <label for="comment">Comments:</label>
        <textarea id="comment" name="comment" style="width: 100%; resize: vertical;"></textarea>
    </div>

    <!--    temp submit button-->
    <div>
        <input type="button" id="submit" name="submit" value="submit" onclick="sendData()">
    </div>
</form>

<div id="results">
    <p id="guideName"></p>
    <p id="guideLanguage"></p>
    <p id="guideRegion"></p>
    <p id="guideCar"></p>
</div>

<script>
    // init form elements
    let isOneDay = document.getElementById("isOneDay");
    let fromDate = document.getElementById("fromDate");
    let toDate = document.getElementById("toDate");
    let language = document.getElementById("language");
    let region = document.getElementById("region");
    let hasCar = document.getElementById("hasCar");
    let comments = document.getElementById("comment");

    // init some elements values
    isOneDay.checked = true;
    if (isOneDay.checked) {
        toDate.disabled = true;
    }

    // init main button
    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.text = "Search"; //изменяем текст кнопки
    tg.MainButton.enable()
    tg.MainButton.show()
    tg.MainButton.expand = false;

    Telegram.WebApp.onEvent('mainButtonClicked', function(){
        sendData();
    });

    // init datepickers
    // populateSelectFrom(region, 'http://localhost:8280/api/region/');
    // populateSelectFrom(language, 'http://localhost:8280/api/language/');
    populateSelectFrom(region, 'https://still-beyond-67512-6a27447420c3.herokuapp.com/api/region/');
    populateSelectFrom(language, 'https://still-beyond-67512-6a27447420c3.herokuapp.com/api/language/');

    function sendData() {

        if (fromDate == null || fromDate.value === '') {
            fromDate.style.border = '1px solid red';
            tg.showAlert('Please enter from date');
            return;
        }


        let initDataURLSP = new URLSearchParams(tg.initData);
        let userStr = initDataURLSP.get('user');
        let user = JSON.parse(userStr);
        // Create an object with the search parameters
        let searchParams = {
            // telegram_id: user.id,
            telegram_id: '3728614',
            from_date: fromDate.value,
            to_date: toDate.value,
            language: language.value,
            region: region.value,
            has_car: hasCar.checked,
            comment: comments.value
        };

        post('https://still-beyond-67512-6a27447420c3.herokuapp.com/api/guide-search', searchParams);
        // post('http://127.0.0.1:8280/api/guide-search/', searchParams);
    }

    // Function to populate a <select> element with options
    async function populateSelectFrom(select, url) {
        const data = await get(url);
        console.log('Populating select with data:', data)
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item; // Assuming the data is a simple array of strings
            option.textContent = item;
            select.appendChild(option);
        });
    }

    function post(url, searchParams) {
        try {
            let responsePromise = fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(searchParams)
            });
            return handleApiResponse(responsePromise);
        } catch (error) {
            console.error('Error during api call: ', error);
            return null;
        }

    }

    function get(url) {
        try {
            let responsePromise = fetch(url);
            return handleApiResponse(responsePromise);
        } catch (error) {
            console.error('Error during api call: ', error);
            return null;
        }
    }

    function handleApiResponse(responsePromise) {
        return responsePromise
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Request failed');
                }
            })
            .then(data => {
                console.log('Response: ', data);
                if (data.code === 1) {
                    console.log('Data fetched successfully:', data.payload);
                    return data.payload;
                } else {
                    console.error('Error fetching data:', response);
                    return null;
                }
            })
    }

    function enable(element, state) {
        element.disabled = state;
    }

</script>
</body>
</html>

