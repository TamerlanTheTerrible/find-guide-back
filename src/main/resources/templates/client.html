<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide Finder WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 0;
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-bg-color);
        }

        form {
            width: 90%;
            max-width: 500px; /* Set a maximum width for mobile-friendly layout */
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
        }

        .form-row > div {
            flex: 1;
            margin-right: 10px;
        }

        input[type="date"],
        select {
            width: 100%;
            font-size: 18px;
            color: var(--tg-theme-text-color);
            border-radius: 6px;
            margin-bottom: 3px;
        }

        form div {
            margin-bottom: 5px;
        }

        label {
            font-style: italic;
        }

    </style>
</head>

<body>
<form>
    <div class="form-row">
        <div>
            <label for="fromDate">From date:</label>
            <input type="date" id="fromDate" name="fromDate">
        </div>
        <div>
            <label for="toDate">To date:</label>
            <input type="date" id="toDate" name="toDate">
        </div>
    </div>

    <div>
        <label for="region">Region:</label>
        <select id="region" name="region">
        </select>
    </div>

    <div>
        <label for="language">Language:</label>
        <select id="language" name="language">
        </select>
    </div>
</form>

<div id="results">
    <p id="guideName"></p>
    <p id="guideLanguage"></p>
    <p id="guideRegion"></p>
    <p id="guideCar"></p>
</div>

<script>
    // init form elements
    let fromDate = document.getElementById("fromDate");
    let toDate = document.getElementById("toDate");
    let language = document.getElementById("language");
    let region = document.getElementById("region");
    let hasCar = document.getElementById("hasCar");
    let comments = document.getElementById("comment");
    // init main button
    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.text = "Search"; //изменяем текст кнопки
    tg.MainButton.enable()
    tg.MainButton.show()
    tg.MainButton.expand = false;

    Telegram.WebApp.onEvent('mainButtonClicked', function(){
        sendData();
    });

    // populateSelectFrom(region, 'http://localhost:8280/api/region/');
    // populateSelectFrom(language, 'http://localhost:8280/api/language/');
    populateSelectFrom(region, 'https://still-beyond-67512-6a27447420c3.herokuapp.com/api/region/');
    populateSelectFrom(language, 'https://still-beyond-67512-6a27447420c3.herokuapp.com/api/language/');

    function sendData() {
        let initDataURLSP = new URLSearchParams(tg.initData);
        let userStr = initDataURLSP.get('user');
        let user = JSON.parse(userStr);
        // Create an object with the search parameters
        let searchParams = {
            telegram_id: user.id,
            from_date: fromDate.value,
            to_date: toDate.value,
            language: language.value,
            region: region.value,
            has_car: hasCar.checked,
            comment: comments.value
        };

        post('https://still-beyond-67512-6a27447420c3.herokuapp.com/api/guide-search', searchParams);
        // post('http://127.0.0.1:8280/api/guide-search/', searchParams);
    }

    // Function to populate a <select> element with options
    async function populateSelectFrom(select, url) {
        const data = await get(url);
        console.log('Populating select with data:', data)
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item; // Assuming the data is a simple array of strings
            option.textContent = item;
            select.appendChild(option);
        });
    }

    function post(url, searchParams) {
        try {
            let responsePromise = fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(searchParams)
            });
            return handleApiResponse(responsePromise);
        } catch (error) {
            console.error('Error during api call: ', error);
            return null;
        }

    }

    function get(url) {
        try {
            let responsePromise = fetch(url);
            return handleApiResponse(responsePromise);
        } catch (error) {
            console.error('Error during api call: ', error);
            return null;
        }
    }

    function handleApiResponse(responsePromise) {
        return responsePromise
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Request failed');
                }
            })
            .then(data => {
                console.log('Response: ', data);
                if (data.code === 1) {
                    console.log('Data fetched successfully:', data.payload);
                    return data.payload;
                } else {
                    console.error('Error fetching data:', response);
                    return null;
                }
            })
    }

</script>
</body>
</html>

